<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.summer.agecompare.mappers">
	
	<select id="do_selectAgeList" parameterType="SearchVO" resultType="Agecompare">
			SELECT DISTINCT SUM(DISTINCT T2.total) OVER(partition by to_char(T2.a_date, 'YY/MM'),T2.age) AS total
			        ,to_char(T2.a_date, 'YY/MM') as a_date
			         ,T2.age, T2.ageTotal
	   		 FROM su_users T1 INNER JOIN(SELECT DISTINCT SUM(amount) OVER(PARTITION BY trade_id, Ta.age,to_char(a_date, 'YY/MM')) AS total
									                , id
									                ,a_date
									                ,trade_id
									                ,amount
									                ,Ta.age, ageTotal
									        FROM ( SELECT TT.a_date
									                    ,TT.amount
									                    ,TT.id
									                    ,TT.trade_id
                                                        ,T3.age,count(*) over(ORDER BY T3.age) AS ageTotal
									                FROM su_accounts TT INNER JOIN(SELECT id 
                                                                                        ,TRUNC(FLOOR(MONTHS_BETWEEN(SYSDATE,TO_DATE(birth,'YYYYMMDD'))/12)+1,-1) AS age 
										                                            FROM su_users) T3 
										                                 ON T3.id = TT.id
									                                     AND to_date(TT.a_date,'YY/MM/DD')
															                 BETWEEN TO_DATE(TO_CHAR(ADD_MONTHS(LAST_DAY(#{pageNum,jdbcType=VARCHAR})+1,-1),'YYYYMMDD'),'YY/MM/DD')
															                AND TO_DATE(last_day(TO_CHAR(LAST_DAY(#{pageSize,jdbcType=VARCHAR}),'YYYYMMDD')),'YY/MM/DD')
									                						) Ta
									              ) T2
							   ON T1.id = T2.id
							   AND T2.age=#{searchWord,jdbcType=VARCHAR}
							   ORDER BY a_date
	</select>
	
	<select id="do_selectMeList" parameterType="SearchVO" resultType="Agecompare">
		SELECT DISTINCT SUM(DISTINCT T2.total) OVER(partition by to_char(T2.a_date, 'YY/MM')) AS total
			        ,to_char(T2.a_date, 'YY/MM') as a_date
                    ,T2.id
	   		 FROM su_users T1 INNER JOIN(SELECT DISTINCT SUM(amount) OVER(PARTITION BY trade_id,to_char(a_date, 'YY/MM')) AS total
									                , id
									                ,a_date
									                ,trade_id
									                ,amount
									        FROM ( SELECT a_date
									                    ,amount
									                    ,id
									                    ,trade_id
									                FROM su_accounts
                                                    WHERE id=#{searchWord,jdbcType=VARCHAR}
                                                    AND TO_DATE(a_date,'YY/MM/DD')
															                 BETWEEN TO_DATE(TO_CHAR(ADD_MONTHS(LAST_DAY(#{pageNum,jdbcType=VARCHAR})+1,-1),'YYYYMMDD'),'YY/MM/DD')
															                AND TO_DATE(last_day(TO_CHAR(LAST_DAY(#{pageSize,jdbcType=VARCHAR}),'YYYYMMDD')),'YY/MM/DD')) Ta
									              ) T2
							   ON T1.id = T2.id
	</select>
</mapper>